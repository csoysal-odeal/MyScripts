  SELECT DISTINCT s.account_no,
       s.merchant_id as UyeIsyeriID,
       s.transferred_account_id,
       s.id as SourceID,
       case when t.serial_no IS NULL then '1' else t.serial_no end as MaliNo,
       s.tckn,
       s.masked_card_number as KartNo,
       CASE WHEN s.status = 'ACTIVATED' THEN 'AKTİF'
            WHEN s.status = 'OTHER' THEN 'DİĞER'
            WHEN s.status = 'WAITING_VERIFICATION' THEN 'DOĞRULAMA BEKLENİYOR'
            WHEN s.status = 'CANCELED' THEN 'İPTAL'
       END as KartBasvuruDurum,
       s.reason as KartDurum,
       s.request_date as TalepTarihi,
       s.group_date as BasimTarihi,
       s.available_amount as KartBakiyesi,
       DATEDIFF(DATE(s.group_date), DATE(s.request_date)) as Talep_BasimGunFark,
       s._createdDate,
       MusteriNo.MusteriNo,
       IsyeriBilgi.unvan,
       IsyeriBilgi.marka,
       IsyeriBilgi.Yetkili,
       IsyeriBilgi.OrgDurum,
       IsyeriBilgi.Iletisim,
       TerminalAbonelik.PlanAd,
       TerminalAbonelik.TerminalAktivasyonTarihi,
       TerminalAbonelik.TerminalDurumu,
       SonKuryeDurum.KuryeDurum,
       SonKuryeDurum.KuryeDetayDurum,
       SonKuryeDurum.courier_date,
       STR_TO_DATE(SonKuryeDurum.TeslimTarihi,"%Y-%m-%d %H:%i:%s") as TeslimTarihi,
       STR_TO_DATE(SonKuryeDurum.DagitimTarihi,"%Y-%m-%d %H:%i:%s") as DagitimTarihi,
       Hata.error_message,
       Hata.trace_id,
       Islemler.SonIslemTarihi,
       Islemler.ToplamTutar as ToplamCiro,
       Islemler.SifirKomisyonCiro,
       KartSifreDetay.firstPinSetDate,
       KartSifreDetay.LastPinChangeDate,
       KartSifreDetay.LastPinSetDate
FROM payout_source.source s
LEFT JOIN odeal.Terminal t ON t.id = s.terminal_id AND t.organisation_id = s.merchant_id
LEFT JOIN (SELECT s.merchant_id, s.terminal_id,s.account_no,s.reason,JSON_UNQUOTE(JSON_EXTRACT(s.metadata, '$."customerNumber"')) as MusteriNo
FROM payout_source.source s
WHERE JSON_UNQUOTE(JSON_EXTRACT(s.metadata, '$."customerNumber"')) IN
(SELECT MAX(JSON_UNQUOTE(JSON_EXTRACT(s.metadata, '$."customerNumber"'))) FROM payout_source.source s GROUP BY s.merchant_id)) as MusteriNo ON MusteriNo.merchant_id = s.merchant_id AND MusteriNo.terminal_id = s.terminal_id AND MusteriNo.account_no = s.account_no
LEFT JOIN (SELECT *
FROM (
SELECT cch.id,
       cch.tckn,
       s.merchant_id,
       cch.card_number,
       cch.type,
       s.available_amount,
       s.terminal_id,
       JSON_UNQUOTE(s.metadata->'$.customerNumber') AS CustomerNumber,
       JSON_UNQUOTE(s.metadata->'$.cardRefNumber') AS cardRefNumber,
       cch.courier_company,
       cch.courier_date,
       cch.courier_main_status as KuryeDurum,
       cch.courier_detail_status as KuryeDetayDurum,
       cch.barcode_number as GonderiNo,
ROW_NUMBER() over (PARTITION BY cch.tckn, cch.barcode_number ORDER BY cch.courier_date DESC) AS Sira,
LAST_VALUE(cch.courier_date) OVER (PARTITION BY cch.tckn, cch.card_number ORDER BY cch.courier_date DESC) AS SonTarih,
STR_TO_DATE(IF((FIRST_VALUE(cch.courier_main_status) OVER (PARTITION BY cch.tckn, cch.card_number ORDER BY cch.courier_date ASC)) = "Dağıtımda", DATE_FORMAT((FIRST_VALUE(cch.courier_date) OVER (PARTITION BY cch.tckn, cch.card_number ORDER BY cch.courier_date ASC)),"%Y-%m-%d %H:%i:%s"),null),"%Y-%m-%d %H:%i:%s") AS DagitimTarihi,
STR_TO_DATE(IF((LAST_VALUE(cch.courier_main_status) OVER (PARTITION BY cch.tckn, cch.card_number ORDER BY cch.courier_date DESC)) = "Teslim", DATE_FORMAT((LAST_VALUE(cch.courier_date) OVER (PARTITION BY cch.tckn, cch.card_number ORDER BY cch.courier_date DESC)),"%Y-%m-%d %H:%i:%s"),null),"%Y-%m-%d %H:%i:%s") AS TeslimTarihi,
LAST_VALUE(cch.courier_main_status) OVER (PARTITION BY cch.tckn, cch.card_number) AS SonDurum,
LAST_VALUE(cch.courier_detail_status) OVER (PARTITION BY cch.tckn, cch.card_number) AS SonDurumDetay
FROM payout_source.card_courier_history cch
         JOIN payout_source.source s ON s.tckn = cch.tckn AND s.account_no = cch.card_number
WHERE s.type = "FIBACARD") as KuryeDurum WHERE KuryeDurum.Sira = 1) as SonKuryeDurum ON SonKuryeDurum.merchant_id = s.merchant_id AND SonKuryeDurum.card_number = s.account_no
LEFT JOIN (SELECT DISTINCT t.organisation_id as UyeIsyeriID,
       t.serial_no as MaliNo, t.id as TerminalID,
       LAST_VALUE(bp.signedDate) OVER (PARTITION BY s.merchant_id, s.terminal_id) as SonIslemTarihi,
       SUM(bp.amount) OVER (PARTITION BY s.merchant_id, s.terminal_id) as ToplamTutar,
       SUM(CASE WHEN bp.appliedRate = 0 THEN bp.amount END) OVER (PARTITION BY s.merchant_id, s.terminal_id) as SifirKomisyonCiro,
       s.merchant_id, s.terminal_id
FROM payout_source.source s
JOIN odeal.Terminal t ON t.organisation_id = s.merchant_id AND t.id = s.terminal_id
LEFT JOIN odeal.TerminalPayment tp ON tp.terminal_id = t.id
LEFT JOIN odeal.BasePayment bp ON bp.id = tp.id AND bp.currentStatus = 6 AND bp.paymentType <> 4 AND bp.signedDate >= DATE_FORMAT(DATE_SUB(CURDATE(), INTERVAL 1 MONTH), "%Y-%m-%d")
WHERE s.type = 'FIBACARD') as Islemler ON Islemler.merchant_id = s.merchant_id AND Islemler.terminal_id = s.terminal_id AND Islemler.MaliNo = t.serial_no
LEFT JOIN (SELECT s.id as SourceID, s.tckn, s.vkn, s.merchant_id, s.terminal_id, s.status, log.entity_id, log.error_message, log.trace_id
FROM payout_source.source s
JOIN (SELECT * FROM payout_source.request_response_logs r WHERE r.id IN (
SELECT MAX(r.id) FROM payout_source.request_response_logs r
GROUP BY r.entity_id)) as log ON s.id = log.entity_id
WHERE s.type='FIBACARD' AND status='WAITING_VERIFICATION') as Hata ON Hata.merchant_id = s.merchant_id AND Hata.terminal_id = s.terminal_id
LEFT JOIN (SELECT o.id as UyeIsyeriID, o.unvan, o.marka, IF(o.isActivated = 1,'Aktif','Pasif') as OrgDurum, CONCAT(m.firstName,' ',m.LastName) as Yetkili, m.phone as Iletisim
FROM odeal.Organisation o
JOIN odeal.Merchant m ON m.organisationId = o.id AND m.`role` = 0
WHERE o.demo = 0 AND o.id IN (SELECT DISTINCT s.merchant_id FROM payout_source.source s WHERE s.type = 'FIBACARD')) as IsyeriBilgi ON IsyeriBilgi.UyeIsyeriID = s.merchant_id
LEFT JOIN (SELECT t.serial_no as MaliNo, t.id as TerminalID, t.organisation_id as UyeIsyeriID, IF(t.terminalStatus=1,'Aktif','Pasif') as TerminalDurumu, t.firstActivationDate as TerminalAktivasyonTarihi,
s.id as AbonelikID, s.activationDate as AbonelikAktivasyonTarihi, s.cancelledAt as AbonelikIptalTarihi, p.id as PlanID, ser.name as Hizmet, p.name as PlanAd, sor.merchant_id, sor.terminal_id
FROM payout_source.source sor
JOIN odeal.Terminal t ON sor.terminal_id = t.id
JOIN subscription.Subscription s ON t.subscription_id = s.id
JOIN subscription.Plan p ON p.id = s.planId
JOIN subscription.Service ser ON ser.id = p.serviceId) as TerminalAbonelik ON TerminalAbonelik.merchant_id = s.merchant_id AND TerminalAbonelik.terminal_id = s.terminal_id AND TerminalAbonelik.MaliNo = t.serial_no
LEFT JOIN (SELECT cd.first_pin_set_date as firstPinSetDate, cd.last_pin_change_date as LastPinChangeDate, cd.last_pin_set_date as LastPinSetDate, s.terminal_id, s.merchant_id
FROM payout_source.card_detail cd
JOIN payout_source.source s ON s.merchant_id = cd.merchant_id
WHERE cd.id IN (SELECT MAX(cd.id) FROM payout_source.card_detail cd GROUP BY cd.tckn)) as KartSifreDetay ON KartSifreDetay.merchant_id = s.merchant_id AND KartSifreDetay.terminal_id = s.terminal_id
LEFT JOIN (SELECT bi.*
FROM payout_source.source s
LEFT JOIN odeal.Terminal t ON t.id = s.terminal_id AND t.organisation_id = s.merchant_id
LEFT JOIN odeal.BankInfo bi ON bi.organisationId = s.merchant_id
WHERE bi.status = 1) as Iban ON Iban.organisationId = s.merchant_id
LEFT JOIN (SELECT KuryeTarih.tckn, KuryeTarih.merchant_id, KuryeTarih.card_number, KuryeTarih.type, KuryeTarih.courier_company, KuryeTarih.barcode_number,
KuryeTarih.courier_main_status,
KuryeTarih.courier_detail_status, KuryeTarih.courier_date, KuryeTarih.SonTarih, KuryeTarih.TeslimTarihi, KuryeTarih.IlkKuryeTarih,
KuryeTarih.SonDurum, KuryeTarih.SonDurumDetay, DATEDIFF(KuryeTarih.SonTarih,KuryeTarih.courier_date) as FarkGun,
KuryeTarih.Sira
FROM (
SELECT s.tckn,s.merchant_id, cch.card_number, s.type, cch.courier_company, cch.barcode_number, cch.courier_main_status, cch.courier_detail_status, cch.courier_date,
ROW_NUMBER() OVER (PARTITION BY cch.tckn, cch.barcode_number ORDER BY cch.courier_date) as Sira,
FIRST_VALUE(cch.courier_date) OVER (PARTITION BY cch.tckn, cch.card_number) AS IlkKuryeTarih,
LAST_VALUE(cch.courier_date) OVER (PARTITION BY cch.tckn, cch.card_number) AS SonTarih,
IF((LAST_VALUE(cch.courier_main_status) OVER (PARTITION BY cch.tckn, cch.card_number)) = "Teslim", DATE_FORMAT((LAST_VALUE(cch.courier_date) OVER (PARTITION BY cch.tckn, cch.card_number)),"%Y-%m-%d %H:%i:%s"),null) AS TeslimTarihi,
LAST_VALUE(cch.courier_main_status) OVER (PARTITION BY cch.tckn, cch.card_number) AS SonDurum,
LAST_VALUE(cch.courier_detail_status) OVER (PARTITION BY cch.tckn, cch.card_number) AS SonDurumDetay
FROM payout_source.card_courier_history cch
JOIN payout_source.source s ON s.tckn = cch.tckn AND s.account_no = cch.card_number
) as KuryeTarih WHERE KuryeTarih.Sira = 1
AND KuryeTarih.tckn NOT IN (SELECT s.tckn FROM payout_source.source s WHERE s.merchant_id IN (301160192,301082761,301253079,301130442,301263531,301264751,301264757,301265031,301265705,301266242,301267382,301267622))
ORDER BY KuryeTarih.tckn, KuryeTarih.courier_date) KuryeDagitimDetay ON KuryeDagitimDetay.merchant_id = s.merchant_id
LEFT JOIN (SELECT o.id as UyeID, t.serial_no as MaliNo, ct.transaction_date as IslemTarihi, ct.transaction_type as IslemDurum,
ct.description as IslemTanimi, ct.amount as IslemTutar, s.account_no as KartNo,
CASE WHEN ct.direction = 'INCOMING' THEN 'Karta Yatan'
    WHEN ct.direction = 'OUTGOING' THEN 'Harcanan' END as KartHareketi
FROM payout_source.source s
LEFT JOIN payout_source.card_transaction ct ON ct.merchant_id = s.merchant_id AND ct.card_number = s.account_no
LEFT JOIN odeal.Organisation o ON o.id = s.merchant_id
LEFT JOIN odeal.Terminal t ON t.id = s.terminal_id AND t.organisation_id = s.merchant_id
WHERE s.type='FIBACARD' AND s.merchant_id NOT IN (301160192,301268032,301082761,301253079,301130442,301263531,301264751,301264757,301265031,301265705,301266242,301267382,301267622)) as KartHareketi ON KartHareketi.UyeID = s.merchant_id AND KartHareketi.MaliNo = t.serial_no AND KartHareketi.KartNo = s.account_no
WHERE s.type='FIBACARD' AND s.merchant_id <> 301196774
AND s.merchant_id NOT IN (301160192,301082761,301253079,301130442,301263531,301264751,301264757,301265031,301265705,301266242,301267382,301267622,301268032)

SELECT o.id, o.unvan, c.name, IF(o.isActivated=1,"Aktif","Pasif") as UyeDurum, o.activatedAt, o.deActivatedAt, MIN(bp.signedDate) as IlkIslemTarih, MAX(bp.signedDate) as SonIslemTarih, COUNT(bp.id) as IslemAdet, SUM(bp.amount) as IslemTutar  FROM odeal.Organisation o
                 JOIN odeal.BasePayment bp ON bp.organisationId = o.id AND bp.currentStatus = 6 AND bp.paymentType <> 4
                JOIN odeal.City c ON c.id = o.cityId
                WHERE o.activatedAt >= "2018-01-01 00:00:00" AND o.activatedAt <= "2020-12-31 23:59:59" AND o.isActivated = 1 AND c.id = 34
GROUP BY o.id, o.unvan, c.name, IF(o.isActivated=1,"Aktif","Pasif"), o.activatedAt, o.deActivatedAt

SELECT c.id, c.name, t.organisation_id, t.serial_no, s.terminal_id, s.status  FROM odeal.Channel c
          JOIN odeal.Terminal t ON t.channelId = c.id
          JOIN payout_source.source s ON s.terminal_id = t.id
          WHERE c.id = 387

SELECT o.id as UyeIsyeriID,
       o.unvan,
       o.marka,
       IF(o.isActivated = 1,'Aktif','Pasif') as OrgDurum,
       CONCAT(m.firstName,' ',m.LastName) as Yetkili,
       m.phone as Iletisim, c.name as Sehir, t.name as Ilce
FROM odeal.Organisation o
LEFT JOIN odeal.City c ON c.id = o.cityId
LEFT JOIN odeal.Town t ON t.id = o.townId
JOIN odeal.Merchant m ON m.organisationId = o.id AND m.`role` = 0
WHERE o.demo = 0 AND o.id IN (SELECT DISTINCT s.merchant_id FROM payout_source.source s WHERE s.type = "FIBACARD")


SELECT o.id as UyeIsyeriID, o.marka as Marka, o.unvan as Unvan, t.serial_no as MaliNo, t.channelId, o.channelId, c.name, IF(bp.paymentType=4,"Nakit","Nakit Dışı") as OdemeTipi,
        SUM(CASE WHEN DATE_FORMAT(bp.signedDate, "%Y-%m") = "2024-01" THEN bp.amount END) as 2024_01,
        SUM(CASE WHEN DATE_FORMAT(bp.signedDate, "%Y-%m") = "2024-02" THEN bp.amount END) as 2024_02,
        SUM(CASE WHEN DATE_FORMAT(bp.signedDate, "%Y-%m") = "2024-03" THEN bp.amount END) as 2024_03,
        SUM(CASE WHEN DATE_FORMAT(bp.signedDate, "%Y-%m") = "2024-04" THEN bp.amount END) as 2024_04,
        SUM(CASE WHEN DATE_FORMAT(bp.signedDate, "%Y-%m") = "2024-05" THEN bp.amount END) as 2024_05,
        SUM(CASE WHEN DATE_FORMAT(bp.signedDate, "%Y-%m") = "2024-06" THEN bp.amount END) as 2024_06,
        SUM(CASE WHEN DATE_FORMAT(bp.signedDate, "%Y-%m") = "2024-07" THEN bp.amount END) as 2024_07,
        SUM(CASE WHEN DATE_FORMAT(bp.signedDate, "%Y-%m") = "2024-08" THEN bp.amount END) as 2024_08,
        SUM(CASE WHEN DATE_FORMAT(bp.signedDate, "%Y-%m") = "2024-09" THEN bp.amount END) as 2024_09,
        SUM(CASE WHEN DATE_FORMAT(bp.signedDate, "%Y-%m") = "2024-10" THEN bp.amount END) as 2024_10,
        SUM(CASE WHEN DATE_FORMAT(bp.signedDate, "%Y-%m") = "2024-11" THEN bp.amount END) as 2024_11,
        SUM(CASE WHEN DATE_FORMAT(bp.signedDate, "%Y-%m") = "2024-12" THEN bp.amount END) as 2024_12,
        SUM(bp.amount) as Genel_Toplam
FROM odeal.Organisation o
JOIN odeal.Terminal t ON t.organisation_id = o.id
LEFT JOIN odeal.Channel c ON c.id = t.channelId
LEFT JOIN odeal.TerminalPayment tp ON tp.terminal_id = t.id
JOIN odeal.BasePayment bp ON bp.id = tp.id AND bp.currentStatus = 6 AND bp.signedDate >= "2024-01-01 00:00:00" AND bp.signedDate <= NOW()
WHERE o.demo = 0 AND t.channelId = 213
GROUP BY o.id, o.marka, o.unvan, t.serial_no, IF(bp.paymentType=4,"Nakit","Nakit Dışı")

SELECT DATE_FORMAT(fp.failedAt,"%Y-%m-%d") as Gun, SUM(bp.amount), COUNT(bp.id) as Adet, fp.reason, fp.reasonCode FROM odeal.FailedPayment fp
         JOIN odeal.BasePayment bp ON bp.paymentId = fp.paymentId WHERE bp.serviceId = 8
GROUP BY DATE_FORMAT(fp.failedAt,"%Y-%m-%d"), fp.reason, fp.reasonCode

SELECT bp.id, bp.signedDate, bp.amount, bp.paymentId, bp.organisationId, bp._createdDate FROM odeal.BasePayment bp WHERE bp.id = 742913184

SELECT fp.id, fp.paymentId, fp.failedAt, fp.amount, fp.organisationId, fp.reason, fp.reasonCode
FROM odeal.FailedPayment fp WHERE fp.failedAt >= "2024-11-27 18:01:41" AND fp.organisationId = 301012999

SELECT *,
COUNT(CASE WHEN Fatura.FaturaDurum="ÖDENDİ" THEN Fatura.terminalId END) OVER (PARTITION BY Fatura.Donem, Fatura.organisationId,Fatura.subscriptionId) as OdendiDonemAdet,
SUM(CASE WHEN Fatura.FaturaDurum="ÖDENDİ" THEN Fatura.OdendiTutar END) OVER (PARTITION BY Fatura.Donem, Fatura.organisationId,Fatura.subscriptionId) as OdendiDonemTutar,
COUNT(CASE WHEN Fatura.FaturaDurum="ÖDENMEDİ" THEN Fatura.terminalId END) OVER (PARTITION BY Fatura.Donem, Fatura.organisationId, Fatura.subscriptionId) as OdenmediDonemAdet,
SUM(CASE WHEN Fatura.FaturaDurum="ÖDENMEDİ" THEN Fatura.OdenmeyenTutar END) OVER (PARTITION BY Fatura.Donem, Fatura.organisationId, Fatura.subscriptionId) as OdenmediDonemTutar,
COUNT(CASE WHEN Fatura.FaturaDurum="HUKUKİ SÜREÇ" THEN Fatura.terminalId END) OVER (PARTITION BY Fatura.Donem, Fatura.organisationId, Fatura.subscriptionId) as HukukiSurecDonemAdet,
SUM(CASE WHEN Fatura.FaturaDurum="HUKUKİ SÜREÇ" THEN Fatura.OdenmeyenTutar END) OVER (PARTITION BY Fatura.Donem, Fatura.organisationId, Fatura.subscriptionId) as HukukiSurecDonemTutar,
COUNT(CASE WHEN Fatura.FaturaDurum="ÖDENMEYECEK" THEN Fatura.terminalId END) OVER (PARTITION BY Fatura.Donem, Fatura.organisationId,Fatura.subscriptionId ) as OdenmeyecekDonemAdet,
SUM(CASE WHEN Fatura.FaturaDurum="ÖDENMEYECEK" THEN Fatura.OdenmeyecekTutar END) OVER (PARTITION BY Fatura.Donem, Fatura.organisationId, Fatura.subscriptionId) as OdenmeyecekDonemTutar,
Fatura.KalanTutar as KalanFaturaTutar,
Fatura.IslemTutar as SonIslemTutar,
Fatura.IslemTarihi as SonIslemTarihi
FROM (
SELECT DISTINCT i.subscriptionId as FaturaAbonelik,
                DATE_FORMAT(i.periodEnd,"%Y-%m") as Donem,
CASE WHEN i.invoiceStatus=0 THEN "ÖDENMEDİ"
    WHEN i.invoiceStatus=1 THEN "ÖDENDİ"
    WHEN i.invoiceStatus=2 THEN "ÖDENMEYECEK"
    WHEN i.invoiceStatus=3 THEN "HUKUKİ SÜREÇTE"
    END as FaturaDurum,
i.id as FaturaID,
i.organisationId,
i.createdAt as FaturaKesimTarihi,
sh.terminalId,
sh.subscriptionId,
t.serial_no,
CASE WHEN t.terminalStatus=0 THEN "PASİF" ELSE "AKTİF" END as TerminalDurum,
SonIslem.IslemTutar,
SonIslem.IslemTarihi,
SonIslem.GeriOdemeTarih,
SonIslem.GeriOdemeTutar,
SonIslem.GeriOdemeDurumu,
SonIslem.GeriOdemeID,
COUNT(CASE WHEN i.invoiceStatus = 0 THEN i.id END) OVER (PARTITION BY o.id, i.id, DATE_FORMAT(i.periodEnd,"%Y-%m")) as OdenmeyenAdet,
SUM(CASE WHEN i.invoiceStatus = 0 THEN i.totalAmount END) OVER (PARTITION BY o.id, i.id, DATE_FORMAT(i.periodEnd,"%Y-%m")) as OdenmeyenTutar,
COUNT(CASE WHEN i.invoiceStatus = 1 THEN i.id END) OVER (PARTITION BY o.id, i.id, DATE_FORMAT(i.periodEnd,"%Y-%m")) as OdendiAdet,
SUM(CASE WHEN i.invoiceStatus = 1 THEN i.totalAmount END) OVER (PARTITION BY o.id, i.id, DATE_FORMAT(i.periodEnd,"%Y-%m")) as OdendiTutar,
COUNT(CASE WHEN i.invoiceStatus = 2 THEN i.id END) OVER (PARTITION BY o.id, i.id, DATE_FORMAT(i.periodEnd,"%Y-%m")) as OdenmeyecekAdet,
SUM(CASE WHEN i.invoiceStatus = 2 THEN i.totalAmount END) OVER (PARTITION BY o.id, i.id, DATE_FORMAT(i.periodEnd,"%Y-%m")) as OdenmeyecekTutar,
COUNT(CASE WHEN i.invoiceStatus = 3 THEN i.id END) OVER (PARTITION BY o.id, i.id, DATE_FORMAT(i.periodEnd,"%Y-%m")) as HukukiSurecAdet,
SUM(CASE WHEN i.invoiceStatus = 3 THEN i.totalAmount END) OVER (PARTITION BY o.id, i.id, DATE_FORMAT(i.periodEnd,"%Y-%m")) as HukukiSurecTutar,
SUM(CASE WHEN i.invoiceStatus = 0 THEN i.remainingAmount END) OVER (PARTITION BY o.id, i.id, DATE_FORMAT(i.periodEnd,"%Y-%m")) as KalanTutar
FROM subscription.Invoice i
LEFT JOIN subscription.SubscriptionHistory sh ON sh.subscriptionId = i.subscriptionId
JOIN odeal.Terminal t ON t.id = sh.terminalId
JOIN odeal.Organisation o ON o.id = t.organisation_id AND o.demo = 0
LEFT JOIN (SELECT * FROM(SELECT t.organisation_id, t.serial_no, t.id, bp.id as IslemID, bp.signedDate as IslemTarihi, bp.amount as IslemTutar, p.id as GeriOdemeID, p.paymentStatus as GeriOdemeDurumu, p.dueDate as GeriOdemeTarih, p.amount as GeriOdemeTutar,
       ROW_NUMBER() OVER (PARTITION BY t.organisation_id, t.serial_no ORDER BY bp.signedDate DESC) as Sira
FROM odeal.Terminal t
JOIN odeal.TerminalPayment tp ON tp.terminal_id = t.id
JOIN odeal.BasePayment bp ON bp.id = tp.id
JOIN odeal.Payback p ON p.id = bp.paybackId
WHERE bp.currentStatus = 6  AND bp.paymentType IN (0,1,2,3,7,8) AND bp.signedDate >= DATE_FORMAT(DATE_SUB(CURDATE(), INTERVAL 5 DAY), "%Y-%m-01")) as Islem
WHERE Islem.Sira = 1) as SonIslem ON SonIslem.organisation_id = t.organisation_id AND SonIslem.serial_no = t.serial_no
WHERE sh.terminalId IS NOT NULL
GROUP BY DATE_FORMAT(i.periodEnd,"%Y-%m"), i.subscriptionId, sh.terminalId, i.invoiceStatus, i.id, SonIslem.IslemTutar,
SonIslem.IslemTarihi, SonIslem.GeriOdemeTarih, SonIslem.GeriOdemeTutar, SonIslem.GeriOdemeDurumu, SonIslem.GeriOdemeID) as Fatura
WHERE Fatura.organisationId = 301000162

SELECT * FROM information_schema.COLUMNS c WHERE c.COLUMN_NAME LIKE "%reasoncode%"

SELECT WOL2.id, WOL2.SerialNumber, WOL2.Status, WOL2.CreatedDate, WOL2.WorkOrderNo, WOL2.WorkOrderType, WOL2.FieldService, WOL2.Metadata FROM (
SELECT *, ROW_NUMBER() OVER (PARTITION BY wol.SerialNumber, wol.WorkOrderNo, wol.Status, wol.WorkOrderType ORDER BY wol.id DESC) as Sira
FROM stargate.WorkOrderLog wol WHERE wol.SerialNumber = "PAX710011988") as WOL2 WHERE WOL2.Sira = 1 ORDER BY WOL2.CreatedDate;

SELECT o.id, o.vergiNo, m.tckNo, o.marka, CASE
WHEN o.businessType=0 THEN "Bireysel"
WHEN o.businessType=1 THEN "Şahıs"
WHEN o.businessType=2 THEN "Tüzel"
WHEN o.businessType=3 THEN "Dernek vb"
ELSE "Bilinmeyen"
END as IsyeriTipi, s.name as Hizmet, o.activatedAt as UyeAktivasyon, IF(o.isActivated=1,"Aktif","Pasif") as UyeDurum,
                   SUM(bp.amount) as ToplamCiro, COUNT(bp.id) as ToplamIslemAdet, MAX(bp.signedDate) as SonIslemTarihi FROM odeal.Organisation o
LEFT JOIN odeal.BasePayment bp ON bp.organisationId = o.id
LEFT JOIN subscription.Service s ON s.id = bp.serviceId
LEFT JOIN odeal.Merchant m ON m.organisationId = o.id AND m.role = 0
WHERE bp.currentStatus = 6 AND bp.paymentType <> 4
AND o.vergiNo IN ('10105227042',
'10124279534','10124480718','10205812414','10219125708','10258940324','10277876772','10429245456','10601775962','10822249716','10883915544','10924390514',
'10985363106',
'10997483618',
'11002080136',
'11177903346',
'11210630802',
'11300543388',
'11446458508',
'11455410078',
'11584979026',
'11614561016',
'11713231964',
'11965839338',
'12095598706',
'12193095954',
'12221926892',
'12227193434',
'12547365924',
'12581551918',
'12622276008',
'12629031464',
'12629031464',
'12694652588',
'12862010448',
'12868625592',
'12998569650',
'13588312168',
'13762570674',
'13925014038',
'14246150542',
'14306951492',
'14332668036',
'14451024652',
'14692266590',
'14703034620',
'14867269586',
'14876551962',
'15065403284',
'15067181616',
'15082218984',
'15253892432',
'15284758448',
'15706233300',
'15930007982',
'16243768232',
'16372191932',
'16604021426',
'16952110780',
'17021988118',
'17180846960',
'17263220632',
'17278185650',
'18283467458',
'18397152646',
'18526249018',
'18859086892',
'18950487956',
'19003636390',
'19040115810',
'19177755002',
'19315361188',
'19367889180',
'19471644118',
'19493844046',
'19516712338',
'19555305058',
'19634441394',
'19687987498',
'19706249446',
'19774804066',
'19844345772',
'19898103830',
'20087013236',
'20243305144',
'20273583932',
'20287717330',
'20447016846',
'20468682174',
'20615320010',
'20947700818',
'21152549346',
'21235007190',
'21235007190',
'21248023484',
'21308151270',
'21610834274',
'21679902556',
'21959434074',
'22190621902',
'22754748908',
'22777875476',
'22838656976',
'22861870240',
'22990648932',
'22993424588',
'23134688364',
'23242701450',
'23365796876',
'23891628986',
'25033112568',
'25036470894',
'25138864546',
'25138945030',
'25168203704',
'25174744666',
'25369601934',
'25408010796',
'25429522674',
'25757144432',
'26089676790',
'26179988246',
'26209073324',
'26462164494',
'26507119236',
'26845914616',
'26932471442',
'27010570552',
'27044425682',
'27049401872',
'27056425168',
'27316934218',
'27547461804',
'27949799994',
'27982795830',
'28337249558',
'28445479946',
'28535270484',
'28744731578',
'29068711284',
'29347995930',
'29353608848',
'29611484016',
'29698419390',
'29737740638',
'30160322568',
'30385689934',
'30952969216',
'31120256268',
'31328478332',
'31384420252',
'31960508350',
'32204148790',
'32242440696',
'32473243356',
'32509840696',
'32606270556',
'32713038186',
'32798040890',
'33142468810',
'33595078628',
'33799820832',
'33916528726',
'33938247896',
'34267507958',
'34726807704',
'34777668064',
'34844006706',
'34942148926',
'34994329878',
'35053876906',
'35083494286',
'35239450180',
'35515339598',
'35845441138',
'35879329006',
'36106205698',
'36403422644',
'36497167452',
'36664899438',
'36950073092',
'37033777692',
'37165708816',
'37319168480',
'37663443950',
'37999187542',
'38608138344',
'38833721274',
'39034352212',
'39067971046',
'39646128144',
'39856601772',
'39863209336',
'40162808526',
'40594026482',
'41128027982',
'41384041678',
'41446053120',
'41476750914',
'42332100454',
'42658864788',
'43435182392',
'43601035866',
'43682068210',
'43933307204',
'44137199626',
'44263160590',
'44635367244',
'44692942156',
'45274931926',
'45520397308',
'45583077964',
'46255339670',
'46405464610',
'46750686552',
'46777186714',
'47287521118',
'47437135790',
'47479505360',
'47854912516',
'47902023782',
'48469075788',
'48547029740',
'48568015142',
'48667228788',
'48853638230',
'48853638230',
'49261425238',
'49858758992',
'49993430944',
'50290743392',
'50773057138',
'50941405648',
'51016308116',
'51115277504',
'51277100788',
'51436466342',
'51646347646',
'51673654434',
'53425421400',
'53449322776',
'54412194482',
'54670590040',
'54895421648',
'54919462954',
'55510232946',
'55630083336',
'55750078434',
'55816626852',
'55819302036',
'56539443986',
'57019178312',
'57085100286',
'57127586382',
'57217507150',
'57562532678',
'57862610724',
'58429044310',
'58753136064',
'58801477910',
'59197544408',
'59386540808',
'59602598262',
'59602598262',
'60142413922',
'60244266112',
'60478298644',
'60580449422',
'60985050148',
'61261176538',
'62977047204',
'63964029852',
'64060115586',
'64090364282',
'64378265416',
'65308028002',
'66028333742',
'66244176208',
'66499307914',
'67201009690',
'67369186950',
'67699249530',
'69412005928',
'70147021282',
'70927052338',
'72196089282',
'73201041592',
'73216028212',
'991078521',
'1160740629',
'710881000',
'1270639953',
'2582089356',
'1390817567',
'1781582581',
'3101463953',
'3251303213',
'4111124293',
'3460794007',
'3312257056',
'3131454722',
'5071507367',
'4651093647',
'5561507814',
'4631438677',
'5360822309',
'6081433395',
'6291433075',
'6260379142',
'6180851580',
'6232029855',
'6180847930',
'6091231191',
'6430393793',
'7721566881',
'6810705341',
'7280834282',
'6621637924',
'9981923218',
'8690842912',
'8981200455',
'7811078878')
GROUP BY o.id, o.vergiNo, m.tckNo, o.marka, s.name
UNION
SELECT o.id, o.vergiNo, m.tckNo, o.marka, CASE
WHEN o.businessType=0 THEN "Bireysel"
WHEN o.businessType=1 THEN "Şahıs"
WHEN o.businessType=2 THEN "Tüzel"
WHEN o.businessType=3 THEN "Dernek vb"
ELSE "Bilinmeyen"
END as IsyeriTipi, s.name as Hizmet, o.activatedAt as UyeAktivasyon, IF(o.isActivated=1,"Aktif","Pasif") as UyeDurum,
                   SUM(bp.amount) as ToplamCiro, COUNT(bp.id) as ToplamIslemAdet, MAX(bp.signedDate) as SonIslemTarihi FROM odeal.Organisation o
LEFT JOIN odeal.BasePayment bp ON bp.organisationId = o.id
LEFT JOIN subscription.Service s ON s.id = bp.serviceId
LEFT JOIN odeal.Merchant m ON m.organisationId = o.id AND m.role = 0
WHERE bp.currentStatus = 6 AND bp.paymentType <> 4
AND m.tckNo IN ('10105227042',
'10124279534',
'10124480718',
'10205812414',
'10219125708',
'10258940324',
'10277876772',
'10429245456',
'10601775962',
'10822249716',
'10883915544',
'10924390514',
'10985363106',
'10997483618',
'11002080136',
'11177903346',
'11210630802',
'11300543388',
'11446458508',
'11455410078',
'11584979026',
'11614561016',
'11713231964',
'11965839338',
'12095598706',
'12193095954',
'12221926892',
'12227193434',
'12547365924',
'12581551918',
'12622276008',
'12629031464',
'12629031464',
'12694652588',
'12862010448',
'12868625592',
'12998569650',
'13588312168',
'13762570674',
'13925014038',
'14246150542',
'14306951492',
'14332668036',
'14451024652',
'14692266590',
'14703034620',
'14867269586',
'14876551962',
'15065403284',
'15067181616',
'15082218984',
'15253892432',
'15284758448',
'15706233300',
'15930007982',
'16243768232',
'16372191932',
'16604021426',
'16952110780',
'17021988118',
'17180846960',
'17263220632',
'17278185650',
'18283467458',
'18397152646',
'18526249018',
'18859086892',
'18950487956',
'19003636390',
'19040115810',
'19177755002',
'19315361188',
'19367889180',
'19471644118',
'19493844046',
'19516712338',
'19555305058',
'19634441394',
'19687987498',
'19706249446',
'19774804066',
'19844345772',
'19898103830',
'20087013236',
'20243305144',
'20273583932',
'20287717330',
'20447016846',
'20468682174',
'20615320010',
'20947700818',
'21152549346',
'21235007190',
'21235007190',
'21248023484',
'21308151270',
'21610834274',
'21679902556',
'21959434074',
'22190621902',
'22754748908',
'22777875476',
'22838656976',
'22861870240',
'22990648932',
'22993424588',
'23134688364',
'23242701450',
'23365796876',
'23891628986',
'25033112568',
'25036470894',
'25138864546',
'25138945030',
'25168203704',
'25174744666',
'25369601934',
'25408010796',
'25429522674',
'25757144432',
'26089676790',
'26179988246',
'26209073324',
'26462164494',
'26507119236',
'26845914616',
'26932471442',
'27010570552',
'27044425682',
'27049401872',
'27056425168',
'27316934218',
'27547461804',
'27949799994',
'27982795830',
'28337249558',
'28445479946',
'28535270484',
'28744731578',
'29068711284',
'29347995930',
'29353608848',
'29611484016',
'29698419390',
'29737740638',
'30160322568',
'30385689934',
'30952969216',
'31120256268',
'31328478332',
'31384420252',
'31960508350',
'32204148790',
'32242440696',
'32473243356',
'32509840696',
'32606270556',
'32713038186',
'32798040890',
'33142468810',
'33595078628',
'33799820832',
'33916528726',
'33938247896',
'34267507958',
'34726807704',
'34777668064',
'34844006706',
'34942148926',
'34994329878',
'35053876906',
'35083494286',
'35239450180',
'35515339598',
'35845441138',
'35879329006',
'36106205698',
'36403422644',
'36497167452',
'36664899438',
'36950073092',
'37033777692',
'37165708816',
'37319168480',
'37663443950',
'37999187542',
'38608138344',
'38833721274',
'39034352212',
'39067971046',
'39646128144',
'39856601772',
'39863209336',
'40162808526',
'40594026482',
'41128027982',
'41384041678',
'41446053120',
'41476750914',
'42332100454',
'42658864788',
'43435182392',
'43601035866',
'43682068210',
'43933307204',
'44137199626',
'44263160590',
'44635367244',
'44692942156',
'45274931926',
'45520397308',
'45583077964',
'46255339670',
'46405464610',
'46750686552',
'46777186714',
'47287521118',
'47437135790',
'47479505360',
'47854912516',
'47902023782',
'48469075788',
'48547029740',
'48568015142',
'48667228788',
'48853638230',
'48853638230',
'49261425238',
'49858758992',
'49993430944',
'50290743392',
'50773057138',
'50941405648',
'51016308116',
'51115277504',
'51277100788',
'51436466342',
'51646347646',
'51673654434',
'53425421400',
'53449322776',
'54412194482',
'54670590040',
'54895421648',
'54919462954',
'55510232946',
'55630083336',
'55750078434',
'55816626852',
'55819302036',
'56539443986',
'57019178312',
'57085100286',
'57127586382',
'57217507150',
'57562532678',
'57862610724',
'58429044310',
'58753136064',
'58801477910',
'59197544408',
'59386540808',
'59602598262',
'59602598262',
'60142413922',
'60244266112',
'60478298644',
'60580449422',
'60985050148',
'61261176538',
'62977047204',
'63964029852',
'64060115586',
'64090364282',
'64378265416',
'65308028002',
'66028333742',
'66244176208',
'66499307914',
'67201009690',
'67369186950',
'67699249530',
'69412005928',
'70147021282',
'70927052338',
'72196089282',
'73201041592',
'73216028212',
'991078521',
'1160740629',
'710881000',
'1270639953',
'2582089356',
'1390817567',
'1781582581',
'3101463953',
'3251303213',
'4111124293',
'3460794007',
'3312257056',
'3131454722',
'5071507367',
'4651093647',
'5561507814',
'4631438677',
'5360822309',
'6081433395',
'6291433075',
'6260379142',
'6180851580',
'6232029855',
'6180847930',
'6091231191',
'6430393793',
'7721566881',
'6810705341',
'7280834282',
'6621637924',
'9981923218',
'8690842912',
'8981200455',
'7811078878')
GROUP BY o.id, o.vergiNo, m.tckNo, o.marka, s.name

SELECT * FROM odeal.Organisation o;
